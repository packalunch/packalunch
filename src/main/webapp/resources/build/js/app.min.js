/*! packalunch v0.1.0, 2015-08-03 */
"use strict";var app=angular.module("userApp",["ui.router","ngResource","ui.bootstrap","ngTouch","spring-security-csrf-token-interceptor"]);app.config(function(a){a.interceptors.push(function(a,b,c){var d,e,f;return a(function(){d=c.get("loginModal"),e=c.get("$http"),f=c.get("$state")}),{responseError:function(a){if(401!==a.status)return a;var c=b.defer();return d().then(function(){c.resolve(e(a.config))})["catch"](function(){f.go("home"),c.reject(a)}),c.promise}}})}),app.run(function(a,b,c){a.$on("$stateChangeStart",function(d,e,f){var g=e.data.requireLogin;console.log("in state change start-------------"),console.log(g),console.log(a.currentUser),console.log("in state change end-------------"),g&&"undefined"==typeof a.currentUser&&(d.preventDefault(),c().then(function(){return b.go(e.name,f)})["catch"](function(){return console.log("in catch state change start-------------"),b.go("home")})),console.log("AFTER")})}),app.controller("UserListController",function(a,b,c,d,e,f){a.users=f.User.query(),a.deleteUser=function(a){d.showPopup("Really delete this?")&&a.$delete(function(){e.location.href="",c.path("/users")})}}),app.controller("AdminListController",function(a,b,c,d,e){a.users=e.Diner.query(),a.addPayment=function(){a.user.$save(function(){c.path("/users")})}}),app.controller("UserSuggestController",function(a,b,c,d){a.people=d.User.query()}),app.controller("HomeController",function(a,b,c){a.weekList=c.Home.query()}),app.controller("LoginModalCtrl",function(a,b,c,d){var e=function(b){c.get("auth/username").success(function(c){c.name?(a.authenticated=!0,$modalInstance.close(c.principal)):a.authenticated=!1,b&&b()}).error(function(){a.authenticated=!1,b&&b()})};e(),b.credentials={},b.login=function(){console.log("posting to login with user credentials"),c.post("login",$.param(b.credentials),{headers:{"content-type":"application/x-www-form-urlencoded"}}).success(function(c){e(function(){a.authenticated?(console.log("Login succeeded"),d.path("/"),b.error=!1,a.authenticated=!0):(console.log("Login failed with redirect"),d.path("/login"),b.error=!0,a.authenticated=!1)})}).error(function(c){console.log("Login failed"),d.path("/login"),b.error=!0,a.authenticated=!1})},b.logout=function(){c.post("logout",{}).success(function(){console.log("Logout successful"),a.authenticated=!1,delete a.currentUser,d.path("/")}).error(function(b){console.log("Logout failed"),a.authenticated=!1,delete a.currentUser})}}),app.controller("navCtrl",function(a,b){}),app.controller("RegistrationController",function(a,b,c,d,e){a.registerInternal=function(c){a.localUser=new d.LocalUser,console.log(c),a.localUser.firstName=c.firstName,a.localUser.lastName=c.lastName,a.localUser.email=c.email,a.localUser.credentialDto={password:c.password},console.log(a.localUser),a.localUser.$save(function(){console.log(a.localUser),"success"==a.localUser.status?(console.log("user save successfully: "+a.localUser.message),b.path("/user")):"failed"==a.localUser.status&&(console.log("user register failed: "+a.localUser.message),a.message=a.localUser.message)})},a.socialRegister=function(){a.userRegister=new d.UserRegister,console.log(a.userRegister),a.userRegister.$save(function(){console.log(a.userRegister),console.log("user registration done"),b.path("/user")})}}),app.controller("UserViewController",function(a,b,c){a.user=c.User.get({id:b.id})}),app.controller("UserCtrl",function(a,b,c){console.log("after user get00000000000000."+b.id)}),app.controller("UserCreateController",function(a,b,c,d,e){a.user=new e.User,a.addUser=function(){a.user.$save(function(){c.path("/users")})}}),app.controller("UserEditController",function(a,b,c,d,e){a.updateUser=function(){a.user.$update(function(){c.path("/users")})},a.addPayment=function(){a.userPayment=new e.DinerPayment,a.userPayment.id=a.user.id,a.userPayment.accountDto={payment_amount:a.user.accountDto.payment_amount},a.userPayment.$save(function(){c.path("/adminView")})},a.loadUser=function(){a.user=e.User.get({id:d.id})},a.loadUser()}),app.controller("UserAddMealCtrl",function(a,b,c,d,e){a.addDinerMeal=function(){console.log("add meal ctl user:-----------addDinerMeal"),d.isLoggedIn()?(console.log("in isLoggedIN"),e.saveMealOrder(a.weekList),a.alerts=[{type:"success",msg:"Chill, we will serve you."}]):(d.promptLogin(),console.log("in FAILED isLoggedIN"))},a.closeAlert=function(b){a.alerts.splice(b,1)}}),app.controller("UserMealCtrl",function(a,b,c){b.getCurrentUser()&&(console.log("UserMeal Controller ==========="+b.getCurrentUser().id),a.user=c.Diner.get({id:b.getCurrentUser().id}))}),app.directive("angucomplete",function(a,b,c,d,e){return{restrict:"EA",scope:{id:"@id",placeholder:"@placeholder",selectedObject:"=selectedobject",url:"@url",dataField:"@datafield",titleField:"@titlefield",descriptionField:"@descriptionfield",imageField:"@imagefield",imageUri:"@imageuri",inputClass:"@inputclass",userPause:"@pause",localData:"=localdata",searchFields:"@searchfields",minLengthUser:"@minlength",matchClass:"@matchclass"},template:'<div class="angucomplete-holder"><input id="{{id}}_value" ng-model="searchStr" type="text" placeholder="{{placeholder}}" class="{{inputClass}}" onmouseup="this.select();" ng-focus="resetHideResults()" ng-blur="hideResults()" /><div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-if="showDropdown"><div class="angucomplete-searching" ng-show="searching">Searching...</div><div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)">No results found</div><div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseover="hoverRow()" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}"><div ng-if="imageField" class="angucomplete-image-holder"><img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/><div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div></div><div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div><div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div><div ng-if="result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div></div></div></div>',link:function(a,f,g){a.lastSearchTerm=null,a.currentIndex=null,a.justChanged=!1,a.searchTimer=null,a.hideTimer=null,a.searching=!1,a.pause=500,a.minLength=3,a.searchStr=null,a.minLengthUser&&""!=a.minLengthUser&&(a.minLength=a.minLengthUser),a.userPause&&(a.pause=a.userPause),isNewSearchNeeded=function(b,c){return b.length>=a.minLength&&b!=c},a.processResults=function(b,d){if(b&&b.length>0){a.results=[];var e=[];a.titleField&&""!=a.titleField&&(e=a.titleField.split(","));for(var f=0;f<b.length;f++){for(var g=[],h=0;h<e.length;h++)g.push(b[f][e[h]]);var i="";a.descriptionField&&(i=b[f][a.descriptionField]);var j="";a.imageUri&&(j=a.imageUri);var k="";a.imageField&&(k=j+b[f][a.imageField]);var l=g.join(" ");if(a.matchClass){var m=new RegExp(d,"i"),n=l.match(m)[0];l=c.trustAsHtml(l.replace(m,'<span class="'+a.matchClass+'">'+n+"</span>"))}var o={title:l,description:i,image:k,originalObject:b[f]};a.results[a.results.length]=o}}else a.results=[]},a.searchTimerComplete=function(c){if(c.length>=a.minLength)if(a.localData){for(var d=a.searchFields.split(","),e=[],f=0;f<a.localData.length;f++){for(var g=!1,h=0;h<d.length;h++)g=g||"string"==typeof a.localData[f][d[h]]&&"string"==typeof c&&a.localData[f][d[h]].toLowerCase().indexOf(c.toLowerCase())>=0;g&&(e[e.length]=a.localData[f])}a.searching=!1,a.processResults(e,c)}else b.get(a.url+c,{}).success(function(b,d,e,f){a.searching=!1,a.processResults(a.dataField?b[a.dataField]:b,c)}).error(function(a,b,c,d){console.log("error")})},a.hideResults=function(){a.hideTimer=d(function(){a.showDropdown=!1},a.pause)},a.resetHideResults=function(){a.hideTimer&&d.cancel(a.hideTimer)},a.hoverRow=function(b){a.currentIndex=b},a.keyPressed=function(b){38!=b.which&&40!=b.which&&13!=b.which?a.searchStr&&""!=a.searchStr?isNewSearchNeeded(a.searchStr,a.lastSearchTerm)&&(a.lastSearchTerm=a.searchStr,a.showDropdown=!0,a.currentIndex=-1,a.results=[],a.searchTimer&&d.cancel(a.searchTimer),a.searching=!0,a.searchTimer=d(function(){a.searchTimerComplete(a.searchStr)},a.pause)):(a.showDropdown=!1,a.lastSearchTerm=null):b.preventDefault()},a.selectResult=function(b){a.matchClass&&(b.title=b.title.toString().replace(/(<([^>]+)>)/gi,"")),a.searchStr=a.lastSearchTerm=b.title,a.selectedObject=b,e.setUser(a.selectedObject),a.showDropdown=!1,a.results=[]};var h=f.find("input");h.on("keyup",a.keyPressed),f.on("keyup",function(b){40===b.which?(a.results&&a.currentIndex+1<a.results.length&&(a.currentIndex++,a.$apply(),b.preventDefault,b.stopPropagation()),a.$apply()):38==b.which?a.currentIndex>=1&&(a.currentIndex--,a.$apply(),b.preventDefault,b.stopPropagation()):13==b.which?a.results&&a.currentIndex>=0&&a.currentIndex<a.results.length?(a.selectResult(a.results[a.currentIndex]),a.$apply(),b.preventDefault,b.stopPropagation()):(a.results=[],a.$apply(),b.preventDefault,b.stopPropagation()):27==b.which?(a.results=[],a.showDropdown=!1,a.$apply()):8==b.which&&(a.selectedObject=null,e.setUser(a.selectedObject),a.$apply())})}}}),app.factory("Api",["$resource",function(a){return{User:a("api/customer/:id",{id:"@id"},{update:{method:"PUT"}}),LocalUser:a("api/localRegister/:id",{id:"@id"}),DinerMeal:a("api/dinerMeal/:id",{id:"@id"}),Diner:a("api/diner/:id",{id:"@id"}),DinerPayment:a("api/diner/:id/payment",{id:"@id"}),UserAuthenticate:a("auth/username/:id",{id:"@id"}),SocialAuth:a("auth/social/:id",{id:"@id"}),Home:a("home/:id",{id:"@id"}),UserRegister:a("api/register/:id",{id:"@id"})}}]),app.factory("authHttpResponseInterceptor",["$q","$location",function(a,b){return{response:function(b){return 401===b.status&&console.log("Response 401"),b||a.when(b)},responseError:function(c){return 401===c.status&&(console.log("Response Error 401",c),b.path("/login").search("returnTo",b.path())),a.reject(c)}}}]),app.config(function(a){a.state("public",{"abstract":!0,template:"<ui-view/>",data:{requireLogin:!1}}).state("app",{"abstract":!0,template:"<ui-view/>",data:{requireLogin:!0}}).state("public.welcome",{url:"",templateUrl:"partials/marketing/_home.html",controller:"HomeController"}).state("public.socialRegisterUser",{url:"/socialsignup",templateUrl:"partials/socialRegistration.html",controller:"RegistrationController"}).state("public.localregister",{url:"/register",templateUrl:"partials/registration.html",controller:"RegistrationController"}).state("public.login",{url:"/login",templateUrl:"partials/login.html",controller:"LoginModalCtrl"}).state("app.user",{url:"/user",templateUrl:"partials/user_home.html",controller:"UserCtrl"}).state("app.adminView",{url:"/admin",templateUrl:"partials/admin_view.html",controller:"AdminListController"}).state("app.customerOrder",{url:"/customerOrder",templateUrl:"partials/admin_view.html",controller:"UserAddMealController"}).state("users",{url:"/users",templateUrl:"partials/customer_list.html",controller:"UserListController"}).state("viewUser",{url:"/users/:id/view",templateUrl:"partials/customer_view.html",controller:"UserViewController"}).state("newUser",{url:"/users/new",templateUrl:"partials/customer_add.html",controller:"UserCreateController"}).state("editUser",{url:"/users/:id/edit",templateUrl:"partials/customer_edit.html",controller:"UserEditController"})}),app.service("authService",["$rootScope","loginModal","$location",function(a,b,c){this.getCurrentUser=function(){return a.currentUser},this.isLoggedIn=function(){return"undefined"!=typeof a.currentUser},this.promptLogin=function(){"undefined"==typeof a.currentUser&&b().then(function(){})["catch"](function(){c.path("/")})}}]),app.service("loginModal",["$modal","$rootScope",function(a,b){function c(a){return b.currentUser=a,console.log(a),a}return function(){var b=a.open({templateUrl:"partials/login.html",controller:"LoginModalCtrl",controllerAs:"LoginModalCtrl"});return b.result.then(c)}}]),app.service("popupService",function(a){this.showPopup=function(b){return a.confirm(b)}}),app.service("userProperties",function(){var a;return{getUser:function(){return a},setUser:function(b){a=b.originalObject}}}),app.service("userMealService",["$state","$location","authService","Api",function(a,b,c,d){this.saveMealOrder=function(a){var e=new d.DinerMeal;e.id=c.getCurrentUser().id,e.dinerSchedule=a,console.log("add meal ctl user:"),console.log(e),e.$save(function(){console.log("meals saved. changing path to /user"),b.path("/user")})}}]);